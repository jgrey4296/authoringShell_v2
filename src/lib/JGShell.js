!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("lodash"),require("rete")):"function"==typeof define&&define.amd?define(["lodash","rete"],e):"object"==typeof exports?exports.JGShell=e(require("lodash"),require("rete")):t.JGShell=e(t._,t.rete)}(this,function(t,e){return function(t){function e(r){if(n[r])return n[r].exports;var i=n[r]={i:r,l:!1,exports:{}};return t[r].call(i.exports,i,i.exports,e),i.l=!0,i.exports}var n={};return e.m=t,e.c=n,e.i=function(t){return t},e.d=function(t,n,r){e.o(t,n)||Object.defineProperty(t,n,{configurable:!1,enumerable:!0,get:r})},e.n=function(t){var n=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(n,"a",n),n},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=9)}([function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var i=function t(e){r(this,t),this.id=e},a=function t(){r(this,t);for(var e=arguments.length,n=Array(e),i=0;i<e;i++)n[i]=arguments[i];this.ids=n},o=function t(){r(this,t);for(var e=arguments.length,n=Array(e),i=0;i<e;i++)n[i]=arguments[i];this.names=n},s=function t(){var e=this,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];if(r(this,t),this.id=n,this.tags=new Set,this.vals=new Map,i instanceof Array){var a=!0,o=!1,s=void 0;try{for(var u,l=i[Symbol.iterator]();!(a=(u=l.next()).done);a=!0){var h=u.value;if(h instanceof c)h.tagNames.forEach(function(t){return e.tags.add(t)});else{if(!(h instanceof f))throw new Error("Unrecognised val list member");this.vals.set(h.valName,h.value)}}}catch(t){o=!0,s=t}finally{try{!a&&l.return&&l.return()}finally{if(o)throw s}}}else null!==i.tags&&null!==i.vals&&(this.tags=new Set(i.tags),this.vals=new Map(i.vals))},u=function t(e,n,i){r(this,t),this.sourceData=e,this.edgeData=n,this.destData=i},c=function t(e){r(this,t),this.tagNames=e},f=function t(e,n){r(this,t),this.valName=e,this.value=n},l=function t(e,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;r(this,t),this.type=e,this.variable=n,this.value=i},h=function t(e,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;r(this,t),this.type=e,this.variable=n,this.value=i},d=function t(e){r(this,t),this.command=e},p=function t(e){r(this,t),this.text=e},g=function t(e){r(this,t),this.name=e};e.Cd=i,e.Rm=a,e.Mk=o,e.Link=u,e.SetTag=c,e.SetValue=f,e.Search=l,e.Refine=h,e.Apply=d,e.Unparameterised=g,e.Import=p,e.EdgeData=s},function(e,n){e.exports=t},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function i(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}function a(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var o=n(1),s=r(o),u=n(3),c=(r(u),n(7)),f=r(c),l=n(0),h=1,d=function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;a(this,t),e=e||"anon",this.id=r||h++,r&&r>h&&(h=r+1),this._edges=new Map,this._values=new Map,this._tags=new Set,this.minimised=!1,this.tag("graphnode"),this.setValue("name",e),n===-1&&(n=this.id),void 0!==n&&null!==n&&(this.setEdge(n,new l.EdgeData(n,new Set,new Map),new l.EdgeData,new l.EdgeData(this.id,new Set,new Map)),this.setValue("_parentId",n))};e.default=d,d.prototype.toJSONCompatibleObj=function(){return{id:this.id,edges:Array.from(this._edges.values()).map(function(t){return t.toJSONCompatibleObj()}),values:Array.from(this._values),tags:Array.from(this._tags)}},d.fromJSON=function(t){var e=new d(null,null,t.id),n=!0,r=!1,a=void 0;try{for(var o,s=t.edges[Symbol.iterator]();!(n=(o=s.next()).done);n=!0){var u=o.value,c=f.default.fromJSON(u),l=null;l=c[0].id===t.id?c[2].id:c[0].id,e.setEdge.apply(e,[l].concat(i(c)))}}catch(t){r=!0,a=t}finally{try{!n&&s.return&&s.return()}finally{if(r)throw a}}return e._values=new Map(t.values),e._tags=new Set(t.tags),e},d.prototype.getParents=function(){var t=this;return s.default.filter(Array.from(this._edges.values()),function(e){return e.dest.id===t.id})},d.prototype.getChildren=function(){var t=this;return s.default.filter(Array.from(this._edges.values()),function(e){return e.source.id===t.id})},d.prototype.toString=function(){return"("+this.id+") : "+this.name._slice(0,10)},d.prototype.setEdge=function(t,e,n,r){if(null===e.id?e.id=this.id:null===r.id&&(r.id=this.id),t!==e.id&&t!==r.id)throw console.log("Inconsistent Edge data:",e,r),new Error("Specified an id for an edge that is inconsistent");if(this.id!==e.id&&this.id!==r.id)throw console.log("Unconnected Target node:".sourceData,r),new Error("Specified an edge unconnected to the targeted node");var i=new f.default(e,n,r);return this._edges.set(t,i),this},d.prototype.getEdgeTo=function(t){if(t instanceof d&&(t=t.id),!this.hasEdgeWith(t))throw new Error("Node does not have specified edge");return this._edges.get(t)},d.prototype.removeEdge=function(t){if(t instanceof d&&(t=t.id),!this.hasEdgeWith(t))throw new Error("Can't remove an edge that doesn't exist");return this._edges.delete(t),this},d.prototype.numOfEdges=function(){return this._edges.size},d.prototype.hasEdgeWith=function(t){return t instanceof d&&(t=t.id),!!this._edges.has(t)},d.prototype.name=function(){return this.getValue("name")},d.prototype.setName=function(t){return this.setValue("name",t),this},d.prototype.setValue=function(t,e){return void 0!==e&&null!==e?this._values.set(t,e):this._values.delete(t),this},d.prototype.hasValue=function(t){return this._values.has(t)},d.prototype.getValue=function(t){if(!this._values.has(t))throw new Error("Can't get a value for a non-existent key");return this._values.get(t)},d.prototype.values=function(){return Array.from(this._values)},d.prototype.tags=function(){return Array.from(this._tags)},d.prototype.hasTag=function(t){return this._tags.has(t)},d.prototype.tag=function(t){return this._tags.add(t),this},d.prototype.tagToggle=function(t){return this.hasTag(t)?this.untag(t):this._tags.add(t),this},d.prototype.untag=function(t){return this._tags.delete(t),this}},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(e,"__esModule",{value:!0});var i=n(1),a=(r(i),{});e.default=a,a.operatorToString=function(t){var e={EQ:"==",LT:"<",GT:">",LTE:"<=",GTE:">=",NE:"!=="};return e[t]?e[t]:(console.warn("No conversion for operator:",t),t)},a.annotate=function(t,e,n,r,i,a,o,s,u,c){t.exit().remove();var f=t.enter().append("g").classed(e,!0);return f.append("rect").classed(e+"rect",!0),f.append("text").classed(e+"text",!0).attr("dy","1.4em"),t.attr("transform",function(t,e){return"translate("+a+","+(n+e*(r+i))+")"}),t.selectAll("."+e+"rect").attr("width",o-2*a).attr("height",r).style("fill",s).attr("rx",10).attr("ry",10),t.selectAll("."+e+"text").attr("transform","translate("+a+","+.2*r+")").text(u).style("fill",c||"white")},a.truncateDrawnText=function(t){for(var e=this.getBBox(),n=t.name.length-4;e.wdith>10&&n>10;)t.shortName=t.name.slice(0,n)+"...",e=this.getBBox(),n-=2}},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(e,"__esModule",{value:!0});var i=n(1),a=(r(i),n(2)),o=r(a),s=new Map([["graphnode",o.default]]),u=function(t){return void 0!==t&&s.has(t.toLowerCase())?s.get(t.toLowerCase()):s.get("graphnode")};e.default=u},function(t,e,n){"use strict";function r(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e.default=t,e}function i(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}Object.defineProperty(e,"__esModule",{value:!0});var a=n(8),o=r(a),s=n(0),u=r(s),c=function(t){return o.optWhitespace.then(t).skip(o.optWhitespace)},f=function(t){return t.skip(o.whitespace)},l="unstash stash root cwd help export prior clear select",h=o.alt.apply(o,i(l.split(" ").map(function(t){return o.string(t)}))),d=h.map(function(t){return new u.Unparameterised(t)}),p=o.string("#"),g=o.string("$"),v=f(o.string(":")),y=o.string(">"),m=o.string("@"),w=o.string("<"),_=f(o.alt(o.string("cd"),m)),E=f(o.string("mk")),x=(f(o.string("link")),f(o.string("rm"))),b=f(o.string("set")),S=f(o.alt(o.string("tag"),p)),k=f(o.alt(o.string("value"),g)),A=f(o.string("search")),M=f(o.string("refine")),O=f(o.string("apply")),D=f(o.string("import")),N=c(o.regex(/[a-zA-Z][a-zA-Z0-9_$]*/)),R=o.string('"').then(o.regex(/[a-zA-Z0-9\- '$%{}&;:.\[\]\(\)]+/)).skip(o.string('"')),C=c(o.regex(/[0-9]+/).map(Number)),I=c(o.string("..")),P=o.regex(/-?[0-9]+(\.[0-9]+)?/).map(Number),T=o.alt(N,R,P).skip(o.optWhitespace),j=o.string("/"),B=o.regex(/[ .a-zA-Z'"0-9-+=_!@#$%^&*()\[\]|]+/),V=o.regex(/[gimuy]*/),q=j.then(o.seqMap(B.skip(j),V.skip(j),function(t,e){return RegExp(t,e)})).skip(o.optWhitespace),U=_.then(o.alt(C,I,N)).map(function(t){return new u.Cd(t)}),J=E.then(N.many()).map(function(t){return new(Function.prototype.bind.apply(u.Mk,[null].concat(i(t))))}),L=x.then(C.many()).map(function(t){return new(Function.prototype.bind.apply(u.Rm,[null].concat(i(t))))}),W=b.then(S).then(N.many()).map(function(t){return new u.SetTag(t)}),z=b.then(k).then(o.seqMap(N,T,function(t,e){return new u.SetValue(t,e)})),F=D.then(o.all).map(function(t){return new u.Import(t)}),G=p.then(N).map(function(t){return new u.SetTag([t])}),Z=g.then(o.seqMap(N.skip(c(v)),o.alt(T,o.succeed(null)),function(t,e){return new u.SetValue(t,e)})),$=o.string("(").then(o.sepBy(o.alt(G,Z),c(o.string(",")))).skip(o.string(")")),H=o.seqMap(C,$.or(o.alt(o.optWhitespace,o.string("()")).result([])),function(t,e){return new u.EdgeData(t,e)}),Q=o.seqMap(H.skip(c(y)),H.or(o.alt(o.optWhitespace,o.string("()")).result(new u.EdgeData)).skip(c(y)),H,function(t,e,n){return new u.Link(t,e,n)}),K=m.then(o.alt(C,I,N)).map(function(t){return new u.Cd(t)}),X=w.then(o.eof).map(function(){return new u.Unparameterised("prior")}),Y=A.then(o.seqMap(N,q,function(t,e){return new u.Search(t,e)})),tt=A.then(o.seqMap(N,o.alt(N,q),o.alt(C,q),function(t,e,n){return new u.Search(t,e,n)})),et=M.then(o.seqMap(N,q,function(t,e){return new u.Refine(t,e)})),nt=M.then(o.seqMap(N,q,q,function(t,e,n){return new u.Refine(t,e,n)})),rt=o.alt(J,L,W,z,tt,Y,nt,et),it=o.alt(G,Z,K,X,Q),at=O.then(o.alt(it,rt)).map(function(t){return new u.Apply(t)}),ot=o.alt(at,it,U,F,d,rt);e.default=ot},function(t,n){t.exports=e},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var i=n(0),a=function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,a=arguments[2];if(r(this,t),!(e instanceof i.EdgeData))throw new Error("Source Details need to be EdgeData");if(!(n instanceof i.EdgeData)&&null!==n)throw new Error("Edge Details need to be edge data");if(!(a instanceof i.EdgeData))throw new Error("Dest Details need to be edge data");if(this.source=e,this.edge=n||new i.EdgeData,this.dest=a,void 0===e||void 0===a)throw new Error("Edges must have details passed to them");if(!("id"in this.source&&"id"in this.dest))throw new Error("Edges must have ids")};e.default=a,a.prototype.connectedTo=function(t){return this.source.id===t||this.dest.id===t},a.prototype.idMatches=function(t,e){if(/dest/.test(e))return this.idMatchesDestination(t);if(/source/.test(e))return this.idMatchesSource(t);throw new Error("IdMatches was passed an unexpected edge type: "+e)},a.prototype.idMatchesSource=function(t){return this.source.id===t},a.prototype.idMatchesDestination=function(t){return this.dest.id===t},a.prototype.toJSONCompatibleObj=function(){return{sourceData:{id:this.source.id,tags:Array.from(this.source.tags),vals:Array.from(this.source.vals)},edgeData:{id:this.edge.id,tags:Array.from(this.edge.tags),vals:Array.from(this.edge.vals)},destData:{id:this.dest.id,tags:Array.from(this.dest.tags),vals:Array.from(this.dest.vals)}}},a.fromJSON=function(t){return[new i.EdgeData(t.sourceData.id,t.sourceData),new i.EdgeData(t.edgeData.id,t.edgeData),new i.EdgeData(t.destData.id,t.destData)]}},function(t,e,n){var r,i,a;!function(n,o){i=[],r=o,a="function"==typeof r?r.apply(e,i):r,void 0!==a&&(t.exports=a)}(this,function(){"use strict";function t(e){if(!(this instanceof t))return new t(e);this._=e}function e(e){return e instanceof t}function n(t,e){return{status:!0,index:t,value:e,furthest:-1,expected:[]}}function r(t,e){return{status:!1,index:-1,value:null,furthest:t,expected:[e]}}function i(t,e){if(!e)return t;if(t.furthest>e.furthest)return t;var n=t.furthest===e.furthest?a(t.expected,e.expected):e.expected;return{status:t.status,index:t.index,value:t.value,furthest:e.furthest,expected:n}}function a(t,e){var n=t.length,r=e.length;if(0===n)return e;if(0===r)return t;for(var i={},a=0;a<n;a++)i[t[a]]=!0;for(var o=0;o<r;o++)i[e[o]]=!0;var s=[];for(var u in i)i.hasOwnProperty(u)&&s.push(u);return s.sort(),s}function o(t){if(!e(t))throw new Error("not a parser: "+t)}function s(t){if("number"!=typeof t)throw new Error("not a number: "+t)}function u(t){if(!(t instanceof RegExp))throw new Error("not a regexp: "+t);for(var e=E(t),n=0;n<e.length;n++){var r=e.charAt(n);if("i"!=r&&"m"!=r&&"u"!=r)throw new Error('unsupported regexp flag "'+r+'": '+t)}}function c(t){if("function"!=typeof t)throw new Error("not a function: "+t)}function f(t){if("string"!=typeof t)throw new Error("not a string: "+t)}function l(t){return 1===t.length?t[0]:"one of "+t.join(", ")}function h(t,e){var n=e.index,r=n.offset;if(r===t.length)return", got the end of the input";var i=r>0?"'...":"'",a=t.length-r>12?"...'":"'";return" at line "+n.line+" column "+n.column+", got "+i+t.slice(r,r+12)+a}function d(t,e){return"expected "+l(e.expected)+h(t,e)}function p(){for(var e=[].slice.call(arguments),r=e.length,a=0;a<r;a+=1)o(e[a]);return t(function(t,a){for(var o,s=new Array(r),u=0;u<r;u+=1){if(o=i(e[u]._(t,a),o),!o.status)return o;s[u]=o.value,a=o.index}return i(n(a,s),o)})}function g(){var t=[].slice.call(arguments);if(0===t.length)throw new Error("seqMap needs at least one argument");var e=t.pop();return c(e),p.apply(null,t).map(function(t){return e.apply(null,t)})}function v(e){return t(e(n,r))}function y(){var e=[].slice.call(arguments),n=e.length;if(0===n)return k("zero alternates");for(var r=0;r<n;r+=1)o(e[r]);return t(function(t,n){for(var r,a=0;a<e.length;a+=1)if(r=i(e[a]._(t,n),r),r.status)return r;return r})}function m(t,e){return w(t,e).or(S([]))}function w(t,e){o(t),o(e);var n=e.then(t).many();return t.chain(function(t){return n.map(function(e){return[t].concat(e)})})}function _(e){f(e);var i="'"+e+"'";return t(function(t,a){var o=a+e.length,s=t.slice(a,o);return s===e?n(o,s):r(a,i)})}function E(t){var e=""+t;return e.slice(e.lastIndexOf("/")+1)}function x(t){return RegExp("^(?:"+t.source+")",E(t))}function b(e,i){u(e),arguments.length>=2?s(i):i=0;var a=x(e),o=""+e;return t(function(t,e){var s=a.exec(t.slice(e));if(s){var u=s[0],c=s[i];if(null!=c)return n(e+u.length,c)}return r(e,o)})}function S(e){return t(function(t,r){return n(r,e)})}function k(e){return t(function(t,n){return r(n,e)})}function A(n){if(e(n))return t(function(t,e){var r=n._(t,e);return r.index=e,r.value="",r});if("string"==typeof n)return A(_(n));if(n instanceof RegExp)return A(b(n));throw new Error("not a string, regexp, or parser: "+n)}function M(e){return c(e),t(function(t,i){var a=t.charAt(i);return i<t.length&&e(a)?n(i+1,a):r(i,"a character matching "+e)})}function O(t){return M(function(e){return t.indexOf(e)>=0})}function D(t){return M(function(e){return t.indexOf(e)<0})}function N(e){return c(e),t(function(t,r){for(var i=r;i<t.length&&e(t.charAt(i));)i++;return n(i,t.slice(r,i))})}function R(e,n){arguments.length<2&&(n=e,e=void 0);var r=t(function(t,e){return r._=n()._,r._(t,e)});return e?r.desc(e):r}function C(t,e){var n=t.slice(0,e).split("\n");return{offset:e,line:n.length,column:n[n.length-1].length+1}}function I(){return k("fantasy-land/empty")}var P=t.prototype;P.parse=function(t){if("string"!=typeof t)throw new Error(".parse must be called with a string as its argument");var e=this.skip(B)._(t,0);return e.status?{status:!0,value:e.value}:{status:!1,index:C(t,e.furthest),expected:e.expected}},P.tryParse=function(t){var e=this.parse(t);if(e.status)return e.value;var n=d(t,e),r=new Error(n);throw r.type="ParsimmonError",r.result=e,r},P.or=function(t){return y(this,t)},P.then=function(t){if("function"==typeof t)throw new Error("chaining features of .then are no longer supported, use .chain instead");return o(t),p(this,t).map(function(t){return t[1]})},P.many=function(){var e=this;return t(function(t,r){for(var a=[],o=void 0;;){if(o=i(e._(t,r),o),!o.status)return i(n(r,a),o);r=o.index,a.push(o.value)}})},P.times=function(e,r){var a=this;return arguments.length<2&&(r=e),s(e),s(r),t(function(t,o){for(var s=[],u=void 0,c=void 0,f=0;f<e;f+=1){if(u=a._(t,o),c=i(u,c),!u.status)return c;o=u.index,s.push(u.value)}for(;f<r&&(u=a._(t,o),c=i(u,c),u.status);f+=1)o=u.index,s.push(u.value);return i(n(o,s),c)})},P.result=function(t){return this.map(function(){return t})},P.atMost=function(t){return this.times(0,t)},P.atLeast=function(t){return g(this.times(t),this.many(),function(t,e){return t.concat(e)})},P.map=function(e){c(e);var r=this;return t(function(t,a){var o=r._(t,a);return o.status?i(n(o.index,e(o.value)),o):o})},P["fantasy-land/map"]=P.map,P.skip=function(t){return p(this,t).map(function(t){return t[0]})},P.mark=function(){return g(V,this,V,function(t,e,n){return{start:t,value:e,end:n}})},P.lookahead=function(t){return this.skip(A(t))},P.desc=function(e){var n=this;return t(function(t,r){var i=n._(t,r);return i.status||(i.expected=[e]),i})},P.fallback=function(t){return this.or(S(t))};var T=t(function(t,e){return e>=t.length?r(e,"any character"):n(e+1,t.charAt(e))}),j=t(function(t,e){return n(t.length,t.slice(e))}),B=t(function(t,e){return e<t.length?r(e,"EOF"):n(e,null)}),V=t(function(t,e){return n(e,C(t,e))});P.concat=P.or,P["fantasy-land/concat"]=P.concat,P.empty=I,P["fantasy-land/empty"]=P.empty,P.of=S,P["fantasy-land/of"]=P.of,P.ap=function(t){return g(t,this,function(t,e){return t(e)})},P["fantasy-land/ap"]=P.ap,P.chain=function(e){var n=this;return t(function(t,r){var a=n._(t,r);return a.status?i(e(a.value)._(t,a.index),a):a})},P["fantasy-land/chain"]=P.chain;var q=b(/[0-9]/).desc("a digit"),U=b(/[0-9]*/).desc("optional digits"),J=b(/[a-z]/i).desc("a letter"),L=b(/[a-z]*/i).desc("optional letters"),W=b(/\s*/).desc("optional whitespace"),z=b(/\s+/).desc("whitespace");return t.all=j,t.alt=y,t.any=T,t.custom=v,t.digit=q,t.digits=U,t.eof=B,t.fail=k,t.formatError=d,t.index=V,t.isParser=e,t.lazy=R,t.letter=J,t.letters=L,t.lookahead=A,t.makeFailure=r,t.makeSuccess=n,t.noneOf=D,t.oneOf=O,t.optWhitespace=W,t.Parser=t,t.regex=b,t.regexp=b,t.sepBy=m,t.sepBy1=w,t.seq=p,t.seqMap=g,t.string=_,t.succeed=S,t.takeWhile=N,t.test=M,t.whitespace=z,t.empty=I,t["fantasy-land/empty"]=I,t.of=S,t["fantasy-land/of"]=S,t})},function(t,e,n){"use strict";function r(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e.default=t,e}function i(t){return t&&t.__esModule?t:{default:t}}function a(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var o=function(){function t(t,e){var n=[],r=!0,i=!1,a=void 0;try{for(var o,s=t[Symbol.iterator]();!(r=(o=s.next()).done)&&(n.push(o.value),!e||n.length!==e);r=!0);}catch(t){i=!0,a=t}finally{try{!r&&s.return&&s.return()}finally{if(i)throw a}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},u=n(1),c=i(u),f=n(6),l=i(f),h=n(2),d=i(h),p=n(4),g=i(p),v=n(3),y=(i(v),n(5)),m=i(y),w=n(0),_=r(w),E=function t(e){a(this,t),this._root=new d.default("_root",-1),this._nodes=new Map,this.set(this._root),this._ruleIds=[],this._cwd=this._root,this._nodeStash=[],this._previousLocation=[this._root.id],this._searchResults=[],this._reteNet=new l.default(e),this._reteNetBackupActions=e,this._reteOutput=[],this._simulation=null,this._parser=m.default};e.default=E,E.prototype.parse=function(t){var e=this._parser.parse(t);return e.status===!1?(console.log("Bad Parse:",e),null):(e=e.value,this.actOnParse(e))},E.prototype.actOnParse=function(t){var e=this;switch(t.constructor){case _.Cd:this.cdByString(t.id);break;case _.Rm:t.ids.forEach(function(t){e.rm(t)});break;case _.Mk:t.names.forEach(function(t){e.addNode(t)});break;case _.Link:this.link(t.sourceData,t.edgeData,t.destData);break;case _.SetTag:t.tagNames.forEach(function(t){return e.cwd().tagToggle(t)});break;case _.SetValue:this.cwd().setValue(t.valName,t.value);break;case _.Search:this.search(t.type,t.variable,t.value);break;case _.Refine:this.refine(t.type,t.variable,t.value);break;case _.Apply:this.actOnSearchResults(t);break;case _.Import:this.import(t.text);break;case _.Unparameterised:return this.processUnparameterisedCommand(t);default:throw new Error("Unrecognised command parsed")}return null},E.prototype.actOnSearchResults=function(t){var e=this,n=this.searchResults(),r=this.cwd().id;if(!(t instanceof _.Apply))throw new Error("Instructed to apply, without passing a CStructs.Apply");if(0===n.length)throw new Error("Instructed to act on empty search results");n.forEach(function(n){e.cdById(n),e.actOnParse(t.command)}),this.cdById(r)},E.prototype.processUnparameterisedCommand=function(t){switch(t.name){case"export":return this.export();case"stash":this.stash();break;case"unstash":this.unstash();break;case"root":this.cdById(this._root.id);break;case"cwd":return this.printState();case"help":return this.help();case"prior":this.cdById(this.prior());break;case"clear":this._searchResults=[];break;case"select":this._searchResults.push(this.cwd().id);break;default:throw new Error("Unrecognised Unparameterised Command: "+t.name)}return null},E.prototype.getCtor=g.default,E.prototype.length=function(){return this._nodes.size},E.prototype.numRules=function(){return this._ruleIds.length},E.prototype.has=function(t){return t instanceof d.default&&(t=t.id),this._nodes.has(t)},E.prototype.get=function(t){if(this.has(Number(t)))return this._nodes.get(Number(t));throw new Error("Node "+t+" does not exist")},E.prototype.set=function(t){if(!(t instanceof d.default))throw new Error("Cannot add a non-GraphNode");if(this.has(t.id))throw console.log(this._nodes),new Error("Cannot replace already existing nodes: "+t.id);this._nodes.set(t.id,t)},E.prototype.rm=function(t){if(t instanceof d.default&&(t=t.id),!this.has(t))throw new Error("Can't remove a node that doesn't exist");var e=!0,n=!1,r=void 0;try{for(var i,a=this.get(t)._edges.keys()[Symbol.iterator]();!(e=(i=a.next()).done);e=!0){var o=i.value;this.get(o).removeEdge(t)}}catch(t){n=!0,r=t}finally{try{!e&&a.return&&a.return()}finally{if(n)throw r}}this._nodes.delete(t)},E.prototype.deleteNode=function(t){this.rm(t)},E.prototype.root=function(){return this._root},E.prototype.cwd=function(){return this._cwd},E.prototype.prior=function(){return c.default.last(this._previousLocation)},E.prototype.searchResults=function(){return Array.from(this._searchResults)},E.prototype.reteOutput=function(){return Array.from(this._reteOutput)},E.prototype.link=function(t,e,n){var r=this.get(t.id),i=this.get(n.id);e.id&&this.get(e.id);r.setEdge(n.id,t,e,n),i.setEdge(t.id,t,e,n)},E.prototype.addNode=function(t,e,n,r,i){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:void 0,o=a?this.get(a):this.cwd();null!==t&&void 0!==t&&""!==t||(t=n||"anon"),n=n||"parent",e=e||"child",r=r||"graphnode";var s=(0,g.default)(r),u=new s(t,o.id);return this.set(u),this.link(new _.EdgeData(o.id,{tags:[n],vals:[]}),new _.EdgeData(null,{tags:[],vals:[]}),new _.EdgeData(u.id,{tags:[e],vals:[]})),u.id},E.prototype.cdByString=function(t){if(!Number.isNaN(Number(t)))return void this.cdById(Number(t));if(null===t.match(/\.\./))throw new Error("Unimplemented: "+t);this.cdById(this.cwd().getValue("_parentId"))},E.prototype.cdById=function(t){if("number"!=typeof t)throw new Error("Cd'ing needs an id, instead got "+(void 0===t?"undefined":s(t)));if(!this.has(t))throw new Error("Can't cd to a non-existent node");this._previousLocation.push(this.cwd().id),this._cwd=this.get(t)},E.prototype.stash=function(){this._nodeStash.push(this.cwd().id)},E.prototype.unstash=function(){return this._nodeStash.pop()},E.prototype.getStash=function(){return c.default.clone(this._nodeStash)},E.prototype.export=function(){var t=[],e=!0,n=!1,r=void 0;try{for(var i,a=this._nodes.values()[Symbol.iterator]();!(e=(i=a.next()).done);e=!0){var o=i.value;t.push(o.toJSONCompatibleObj())}}catch(t){n=!0,r=t}finally{try{!e&&a.return&&a.return()}finally{if(n)throw r}}return{description:"json",text:JSON.stringify({nodes:t,root:this._root.id})}},E.prototype.import=function(t){var e=JSON.parse(t);console.log("Loading data:",e),this._nodes.clear();var n=!0,r=!1,i=void 0;try{for(var a,o=e.nodes[Symbol.iterator]();!(n=(a=o.next()).done);n=!0){var s=a.value,u=d.default.fromJSON(s);this.set(u)}}catch(t){r=!0,i=t}finally{try{!n&&o.return&&o.return()}finally{if(r)throw i}}this._root=this._nodes.get(e.root),this._cwd=this._root},E.prototype.extend=function(t){},E.prototype.search=function(t,e){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a=[];switch(a=i?this._searchResults.map(function(t){return n.get(t)}):Array.from(this._nodes.values()),t){case"name":if(null!==r||!(e instanceof RegExp))throw new Error("Incorrect Name Search");var s=a.filter(function(t){return e.test(t.name())});this._searchResults=s.map(function(t){return t.id});break;case"tag":if(null!==r||!(e instanceof RegExp))throw new Error("Incorrect Tag Search");var u=a.map(function(t){return[t.id,t.tags()]}),f=u.filter(function(t){var n=o(t,2),r=(n[0],n[1]);return c.default.some(r,function(t){return e.test(t)})}),l=f.map(function(t){var e=o(t,2),n=e[0];e[1];return n});this._searchResults=l;break;case"value":if(e instanceof RegExp&&null!==r&&r instanceof RegExp){var h=a.filter(function(t){return c.default.some(t.values(),function(t){var n=o(t,2),i=n[0],a=n[1];return e.test(i)&&r.test(a)})});this._searchResults=h.map(function(t){return t.id})}else if(e instanceof RegExp&&null===r){var d=a.filter(function(t){return c.default.some(t.values(),function(t){var n=o(t,2),r=n[0];n[1];return e.test(r)})});this._searchResults=d.map(function(t){return t.id})}else if(e instanceof RegExp||null!==r){if(e instanceof RegExp||null===r||r instanceof RegExp)throw new Error("Unrecognised search attempt");var p=a.filter(function(t){return t.hasValue(e)&&t.getValue(e)===r});this._searchResults=p.map(function(t){return t.id})}else{var g=a.filter(function(t){return t.hasValue(e)});this._searchResults=g.map(function(t){return t.id})}break;case"edge":if(null===r||!/dest|source/.test(e))throw new Error("Incorrect Edge Search");var v=a.filter(function(t){return t.hasEdgeWith(r)&&t.getEdgeTo(r).idMatches(r,e)});this._searchResults=v.map(function(t){return t.id});break;default:throw new Error("Incorrect Search Specified")}},E.prototype.refine=function(t,e,n){return this.search(t,e,n,!0)},E.prototype.dfs=function(){throw new Error("Unimplemented: DFS")},E.prototype.bfs=function(){throw new Error("Unimplemented: BFS")},E.prototype.help=function(){throw new Error("Unimplemented: Help")},E.prototype.getPath=function(){for(var t=[],e=this.cwd();e.id!==this._root.id&&e.getValue("_parentId")!==e.id;)t.unshift([e.name(),e.id]),e=this.get(e.getValue("_parentId"));return t.unshift([this._root.name(),this._root.id]),t},E.prototype.printState=function(){var t=this.cwd();return{description:"stateDescription",inputs:t.getParents(),node:t,outputs:t.getChildren(),searchResults:this.searchResults(),currentPath:this.getPath(),stash:this.getStash()}}}])});