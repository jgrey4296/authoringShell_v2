!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("lodash"),require("rete")):"function"==typeof define&&define.amd?define(["lodash","rete"],e):"object"==typeof exports?exports.JGShell=e(require("lodash"),require("rete")):t.JGShell=e(t._,t.rete)}(this,function(t,e){return function(t){function e(r){if(n[r])return n[r].exports;var i=n[r]={i:r,l:!1,exports:{}};return t[r].call(i.exports,i,i.exports,e),i.l=!0,i.exports}var n={};return e.m=t,e.c=n,e.i=function(t){return t},e.d=function(t,n,r){e.o(t,n)||Object.defineProperty(t,n,{configurable:!1,enumerable:!0,get:r})},e.n=function(t){var n=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(n,"a",n),n},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=17)}([function(e,n){e.exports=t},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0}),e.GraphNode=void 0;var o=function(){function t(t,e){var n=[],r=!0,i=!1,o=void 0;try{for(var s,a=t[Symbol.iterator]();!(r=(s=a.next()).done)&&(n.push(s.value),!e||n.length!==e);r=!0);}catch(t){i=!0,o=t}finally{try{!r&&a.return&&a.return()}finally{if(i)throw o}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),s=n(0),a=r(s),u=(n(2),n(7)),c=0,h=function t(e,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;i(this,t),this.id=r||c++,r&&r>c&&(c=r+1),this._name=e||"anon",this._edges=new Map,this.parentId=n,this._values=new Map,this._tags=new Set,this.minimised=!1,this._tags.add("graphnode")};h.fromJSON=function(t){var e=new h(t.name,t.parent,t.id),n=!0,r=!1,i=void 0;try{for(var s,a=t.edges[Symbol.iterator]();!(n=(s=a.next()).done);n=!0){var c=s.value,f=o(c,2),l=(f[0],f[1]),p=u.Edge.fromJSON(l),d=null;d=p.source.id===t.id?l.dest.id:l.source.id,e._edges.set(d,p)}}catch(t){r=!0,i=t}finally{try{!n&&a.return&&a.return()}finally{if(r)throw i}}return e._values=new Map(t.values),e._tags=new Set(t.tags),e},h.prototype.getParents=function(){var t=this;return a.default.filter(Array.from(this._edges.values()),function(e){return e.dest.id===t.id})},h.prototype.getChildren=function(){var t=this;return a.default.filter(Array.from(this._edges.values()),function(e){return e.source.id===t.id})},h.prototype.toJSONCompatibleObj=function(){return{id:this.id,name:this._name,parent:this.parentId,edges:Array.from(this._edges),values:Array.from(this._values),tags:Array.from(this._tags)}},h.prototype.toString=function(){return"("+this.id+") : "+this.name._slice(0,10)},h.prototype.setEdge=function(t,e,n,r){if(t instanceof h&&(t=t.id),null===e.id?e.id=this.id:null===r.id&&(r.id=this.id),t!==e.id&&t!==r.id)throw new Error("Specified an id for an edge that is inconsistent");if(this.id!==e.id&&this.id!==r.id)throw new Error("Specified an edge unconnected to the targeted node");var i=new u.Edge(e,n,r);return this._edges.set(t,i),this},h.prototype.getEdgeTo=function(t){if(t instanceof h&&(t=t.id),!this.hasEdgeWith(t))throw new Error("Node does not have specified edge");return this._edges.get(t)},h.prototype.removeEdge=function(t){if(t instanceof h&&(t=t.id),!this.hasEdgeWith(t))throw new Error("Can't remove an edge that doesn't exist");return this._edges.delete(t),this},h.prototype.numOfEdges=function(){return this._edges.size},h.prototype.hasEdgeWith=function(t){return t instanceof h&&(t=t.id),!!this._edges.has(t)},h.prototype.name=function(){return this._name},h.prototype.setName=function(t){return this._name=t,this},h.prototype.setValue=function(t,e){return void 0!==e?this._values.set(t,e):this._values.delete(t),this},h.prototype.getValue=function(t){if(!this._values.has(t))throw new Error("Can't get a value for a non-existent key");return this._values.get(t)},h.prototype.values=function(){return Array.from(this._values)},h.prototype.tags=function(){return Array.from(this._tags)},h.prototype.hasTag=function(t){return this._tags.has(t)},h.prototype.tag=function(t){return this._tags.add(t),this},h.prototype.tagToggle=function(t){return this.hasTag(t)?this.untag(t):this._tags.add(t),this},h.prototype.untag=function(t){return this._tags.delete(t),this},e.GraphNode=h},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(e,"__esModule",{value:!0}),e.util=void 0;var i=n(0),o=(r(i),{});o.operatorToString=function(t){var e={EQ:"==",LT:"<",GT:">",LTE:"<=",GTE:">=",NE:"!=="};return e[t]?e[t]:(console.warn("No conversion for operator:",t),t)},o.annotate=function(t,e,n,r,i,o,s,a,u,c){t.exit().remove();var h=t.enter().append("g").classed(e,!0);return h.append("rect").classed(e+"rect",!0),h.append("text").classed(e+"text",!0).attr("dy","1.4em"),t.attr("transform",function(t,e){return"translate("+o+","+(n+e*(r+i))+")"}),t.selectAll("."+e+"rect").attr("width",s-2*o).attr("height",r).style("fill",a).attr("rx",10).attr("ry",10),t.selectAll("."+e+"text").attr("transform","translate("+o+","+.2*r+")").text(u).style("fill",c||"white")},o.truncateDrawnText=function(t){for(var e=this.getBBox(),n=t.name.length-4;e.wdith>10&&n>10;)t.shortName=t.name.slice(0,n)+"...",e=this.getBBox(),n-=2},e.util=o},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var i=function t(e){r(this,t),this.id=e},o=function t(){r(this,t);for(var e=arguments.length,n=Array(e),i=0;i<e;i++)n[i]=arguments[i];this.ids=n},s=function t(){r(this,t);for(var e=arguments.length,n=Array(e),i=0;i<e;i++)n[i]=arguments[i];this.names=n},a=function t(e,n){r(this,t),this.sourceId=e,this.destId=n},u=function t(e){r(this,t),this.tagName=e},c=function t(e,n){r(this,t),this.valName=e,this.value=n},h=function t(e,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;r(this,t),this.type=e,this.variable=n,this.value=i},f=function t(e,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;r(this,t),this.type=e,this.variable=n,this.value=i},l=function t(e){r(this,t),this.command=e},p=function t(e){r(this,t),this.text=e},d=function t(e){r(this,t),this.name=e};e.Cd=i,e.Rm=o,e.Mk=s,e.Link=a,e.SetTag=u,e.SetValue=c,e.Search=h,e.Refine=f,e.Apply=l,e.Unparameterised=d,e.Import=p},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(e,"__esModule",{value:!0}),e.getCtor=void 0;var i=n(0),o=(r(i),n(1)),s=n(14),a=n(10),u=n(8),c=n(13),h=n(9),f=n(15),l=n(12),p=n(11),d=new Map([["graphnode",o.GraphNode],["rule",s.Rule],["condition",a.Condition],["action",u.Action],["institution",c.Institution],["bookmark",h.Bookmark],["state",f.State],["event",p.Event],["fsm",l.FSM]]),y=function(t){return void 0!==t&&d.has(t.toLowerCase())?d.get(t.toLowerCase()):d.get("graphnode")};e.getCtor=y},function(t,e,n){"use strict";function r(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e.default=t,e}function i(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}Object.defineProperty(e,"__esModule",{value:!0}),e.parser=void 0;var o=n(16),s=r(o),a=n(3),u=r(a),c=function(t){return s.optWhitespace.then(t).skip(s.optWhitespace)},h=function(t){return t.skip(s.whitespace)},f="unstash stash root cwd help export prior clear",l=s.alt.apply(s,i(f.split(" ").map(function(t){return s.string(t)}))),p=l.map(function(t){return new u.Unparameterised(t)}),d=h(s.string("cd")),y=h(s.string("mk")),g=h(s.string("link")),m=h(s.string("rm")),v=h(s.string("set")),w=h(s.string("tag")),_=h(s.string("value")),b=h(s.string("search")),x=h(s.string("refine")),k=h(s.string("apply")),E=h(s.string("import")),S=c(s.regex(/[a-zA-Z][a-zA-Z0-9_$]*/)),N=s.string('"').then(s.regex(/[a-zA-Z0-9\- '$%{}&;:.]+/)).skip(s.string('"')),O=c(s.regex(/[0-9]+/).map(Number)),T=c(s.string("..")),A=s.regex(/-?[0-9]+(\.[0-9]+)?/).map(Number),M=s.alt(S,N,A).skip(s.optWhitespace),j=s.string("/"),I=s.regex(/[ .a-zA-Z'"0-9-+=_!@#$%^&*()\[\]|]+/),C=s.regex(/[gimuy]*/),R=j.then(s.seqMap(I.skip(j),C.skip(j),function(t,e){return RegExp(t,e)})).skip(s.optWhitespace),P=d.then(s.alt(O,T,S)).map(function(t){return new u.Cd(t)}),G=y.then(S.many()).map(function(t){return new(Function.prototype.bind.apply(u.Mk,[null].concat(i(t))))}),B=g.then(s.seqMap(O,O,function(t,e){return new u.Link(t,e)})),U=m.then(O.many()).map(function(t){return new(Function.prototype.bind.apply(u.Rm,[null].concat(i(t))))}),D=v.then(w).then(S).map(function(t){return new u.SetTag(t)}),L=v.then(_).then(s.seqMap(S,M,function(t,e){return new u.SetValue(t,e)})),q=E.then(s.all).map(function(t){return new u.Import(t)}),F=b.then(s.seqMap(S,R,function(t,e){return new u.Search(t,e)})),z=b.then(s.seqMap(S,s.alt(S,R),s.alt(O,R),function(t,e,n){return new u.Search(t,e,n)})),J=x.then(s.seqMap(S,R,function(t,e){return new u.Refine(t,e)})),W=x.then(s.seqMap(S,R,R,function(t,e,n){return new u.Refine(t,e,n)})),V=s.alt(G,B,U,D,L,z,F,W,J),Z=k.then(V).map(function(t){return new u.Apply(t)}),$=s.alt(Z,P,q,p,V);e.parser=$},function(t,n){t.exports=e},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var i=function t(e,n,i){if(r(this,t),this.source=e,this.edge=n,this.dest=i,!("id"in this.source&&"id"in this.dest))throw new Error("Edges must have ids")};i.fromJSON=function(t){return new i(t.source,t.edge,t.dest)},i.prototype.connectedTo=function(t){return this.source.id===t||this.dest.id===t},i.prototype.idMatches=function(t,e){if(/dest/.test(e))return this.idMatchesDestination(t);if(/source/.test(e))return this.idMatchesSource(t);throw new Error("IdMatches was passed an unexpected edge type: "+e)},i.prototype.idMatchesSource=function(t){return this.source.id===t},i.prototype.idMatchesDestination=function(t){return this.dest.id===t},e.Edge=i},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(e,"__esModule",{value:!0}),e.Action=void 0;var i=n(0),o=r(i),s=n(1),a=function(t,e,n,r,i){for(s.GraphNode.call(this,t,e,"action",{},i),this.tags.actionType=n||"assert";r&&r.length>=2;)this.values[r.shift()]=r.shift();this.arithmeticActions={},this.regexActions={},this.timing={invalidateOffset:0,performOffset:0,unperformOffset:0},this.priority=0};a.prototype=Object.create(s.GraphNode.prototype),a.constructor=a,a.prototype.setArith=function(t,e,n){if(arguments.length<1)throw new Error("setArith needs at least a value");3!==arguments.length?delete this.arithmeticActions[t]:this.arithmeticActions[t]=[e,n]};var u=/\/(.+)\/(.+)\/(.*)/;a.prototype.setRegex=function(t,e){if(void 0===e)delete this.regexActions[t];else{var n=e.match(u);if(null===n||4!==n.length)throw new Error("Invalid regex");this.regexActions[t]=[n[1],n[3],n[2]]}},a.prototype.setTiming=function(t,e){void 0!==this.timing[t]&&(this.timing[t]=Number(e))},a.prototype.setPriority=function(t){if(isNaN(t))throw new Error("Priority must be a number");this.priority=t},a.prototype.getDescriptionObjects=function(t){var e=this;if(this.minimised)return[{name:this.toString()+"...",background:"title"}];var n=void 0!==t?[]:["Values","Source For:","Sink For:"],r=o.default.reject(this.getDescriptionObjectsBase(),function(t){return n.indexOf(t.name)!==-1});r.push({name:"Data",values:o.default.toPairs(this.values).map(function(t){return t.join(" : ")}),background:"data"}),r.push({name:"Arithmetic Actions",values:o.default.keys(this.arithmeticActions).map(function(t){return t+" "+e.arithmeticActions[t][0]+" "+e.arithmeticActions[t][1]}),background:"arith"}),r.push({name:"Regex Actions",values:o.default.keys(this.regexActions).map(function(t){return t+" ~= /"+e.regexActions[t][0]+"/"+e.regexActions[t][2]+"/"+e.regexActions[t][1]}),background:"regex"}),r.push({name:"Timing",values:o.default.keys(this.timing).map(function(t){return t+" : "+e.timing[t]}),background:"priority"});var i=o.default.toPairs(this.linkedNodes).filter(function(t){return/sink/.test(t[1])});return 0===i.length?r.push({name:"SINK ID: NULL",background:"link"}):1===i.length?r.push({name:"SINK ID: "+i[0][0],background:"link"}):i.length>1&&r.push({name:"SINK IDS:",values:i.map(function(t){return t[0]}),background:"link"}),r.push({name:"Priority: "+this.priority,background:"priority"}),r},e.Action=a},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(e,"__esModule",{value:!0}),e.Bookmark=void 0;var i=n(0),o=(r(i),n(1)),s=function(t,e,n,r,i){o.GraphNode.call(this,t,e,"bookmark",{},i),this.longName=t,this.url=[r]};s.prototype=Object.create(o.GraphNode.prototype),s.constructor=s,s.prototype.getDescriptionObjects=function(){this.getDescriptionObjectsBase().push({name:"URL",values:this.url,background:"link"})},e.Bookmark=s},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(e,"__esModule",{value:!0}),e.Condition=void 0;var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},o=n(0),s=r(o),a=n(1),u=n(2),c=["positive","negative","negConjCondition"],h=function(t,e,n,r,i){a.GraphNode.call(this,t,e,"condition",{},i),this.tags.conditionType="positive",this.constantTests=[],this.bindings={}};h.prototype=Object.create(a.GraphNode.prototype),h.constructor=h,h.prototype.setConditionType=function(t){if(c.indexOf(t)===-1)throw new Error("Unrecognised condition type");this.tags.conditionType=t},h.prototype.setTest=function(t,e,n,r){arguments<2?this.constantTests.splice(t,1):void 0!==t&&void 0!==this.constantTests[t]?this.constantTests[t]={field:e,operator:n,value:r}:this.constantTests.push({field:e,operator:n,value:r})},h.prototype.setBinding=function(t,e,n){arguments<2?delete this.bindings[t]:this.bindings[t]=[e,n]},h.prototype.getDescriptionObjects=function(){var t=this;if(this.minimised)return[{name:this.toString()+"...",background:"title"}];if("negConjCondition"===this.tags.conditionType){var e=[];return e.push({name:this.toString(),background:"title"}),e.push({name:"Conditions",values:s.default.toPairs(this.linkedNodes).filter(function(t){return/^condition/.test(t[1])}).map(function(t){return t.join(" : ")}),background:"link"}),e.push({name:"Tags",values:s.default.toPairs(this.tags).map(function(t){return t.join(" : ")}),background:"tags"}),e}var n=[];n.push({name:this.toString(),background:"title"}),n.push({name:"IF:",values:this.constantTests.map(function(t,e){return"("+e+"): wme.data."+t.field+" "+u.util.operatorToString(t.operator)+" "+t.value}),background:"test"}),n.push({name:"BIND:",values:s.default.keys(this.bindings).map(function(t){return/^[#\$]id/.test(t[0])?t+" <-- wme.id :: "+s.default.flatten(this.bindings[t][1]).join(" "):t+" <-- wme.data."+this.bindings[t][0]+" :: "+s.default.flatten(this.bindings[t][1]).join(" ")},this),background:"binding"});var r=s.default.toPairs(this.linkedNodes).filter(function(t){return/source/.test(t[1])});return 0===r.length?n.push({name:"SOURCE ID: NULL",background:"link"}):1===r.length?n.push({name:"SOURCE ID: "+r[0][0],background:"link"}):r.length>1&&n.push({name:"SOURCE IDS:",values:r.map(function(t){return t[0]}),background:"link"}),n.push({name:"Tags",values:s.default.keys(this.tags).map(function(e){return e+" : "+t.tags[e]}),background:"tags"}),n},h.prototype.getActiveLinks=function(t){void 0===t&&(t=["children","parents","conditions"]);var e=new Set;return t.forEach(function(t){"object"===i(this[t])&&s.default.keys(this[t]).forEach(function(t){return e.add(t)})},this),Array.from(e)},e.Condition=h},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(e,"__esModule",{value:!0}),e.Event=void 0;var i=n(0),o=(r(i),n(1)),s=function(t,e,n,r,i){o.GraphNode.call(this,t,e,"event",{},i)};s.prototype=Object.create(o.GraphNode.prototype),s.constructor=s,e.Event=s},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(e,"__esModule",{value:!0}),e.FSM=void 0;var i=n(0),o=r(i),s=n(1),a=function(t,e,n,r,i){s.GraphNode.call(this,t,e,"fsm",{},i),this.instanceStates={}};a.prototype=Object.create(s.GraphNode.prototype),a.constructor=a,a.prototype.getDescriptionObjects=function(){var t=this.getDescriptionObjectsBase();return t.push({name:"Currently Utilized By:",values:o.default.toPairs(this.positions).map(function(t){return t.join(" : ")})}),t},e.FSM=a},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(e,"__esModule",{value:!0}),e.Institution=void 0;var i=n(0),o=(r(i),n(1)),s=function(t,e,n,r,i){var s=[{name:"roles",relType:"child",recType:"parent",subRelations:"incumbent challenger controlled exempt".split(" ").map(function(t){return{name:t,relType:"child",recType:"parent"}})},{name:"activities",subRelations:"physical symbolic communicative unbound".split(" ").map(function(t){return{name:t,relType:"child",recType:"parent"}})},{name:"IGU",relType:"child",recType:"parent"},{name:"FactGrammar",relType:"child",recType:"parent",subRelations:"physical symbolic communicative unbound".split(" ").map(function(t){return{name:t,relType:"child",recType:"parent"}})},{name:"valueHierarchy",relType:"child",recType:"parent"},{name:"norms",relType:"child",recType:"parent",subRelations:"empiricallyExpected normativelyExpected sanctionable".split(" ").map(function(t){return{name:t,relType:"child",recType:"parent"}})},{name:"externalEffectors",relType:"child",recType:"parent"}];o.GraphNode.call(this,t,e,"institution",s,i)};s.constructor=s,s.prototype=Object.create(o.GraphNode.prototype),e.Institution=s},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(e,"__esModule",{value:!0}),e.Rule=void 0;var i=n(0),o=(r(i),n(1)),s=function(t,e,n,r,i){o.GraphNode.call(this,t,e,"rule",{},i)};s.prototype=Object.create(o.GraphNode.prototype),s.constructor=s,e.Rule=s},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(e,"__esModule",{value:!0}),e.State=void 0;var i=n(0),o=(r(i),n(1)),s=function(t,e,n,r,i){o.GraphNode.call(this,t,e,"state",{},i)};s.prototype=Object.create(o.GraphNode.prototype),s.constructor=s,e.State=s},function(t,e,n){var r,i,o;!function(n,s){i=[],r=s,o="function"==typeof r?r.apply(e,i):r,void 0!==o&&(t.exports=o)}(this,function(){"use strict";function t(e){if(!(this instanceof t))return new t(e);this._=e}function e(e){return e instanceof t}function n(t,e){return{status:!0,index:t,value:e,furthest:-1,expected:[]}}function r(t,e){return{status:!1,index:-1,value:null,furthest:t,expected:[e]}}function i(t,e){if(!e)return t;if(t.furthest>e.furthest)return t;var n=t.furthest===e.furthest?o(t.expected,e.expected):e.expected;return{status:t.status,index:t.index,value:t.value,furthest:e.furthest,expected:n}}function o(t,e){var n=t.length,r=e.length;if(0===n)return e;if(0===r)return t;for(var i={},o=0;o<n;o++)i[t[o]]=!0;for(var s=0;s<r;s++)i[e[s]]=!0;var a=[];for(var u in i)i.hasOwnProperty(u)&&a.push(u);return a.sort(),a}function s(t){if(!e(t))throw new Error("not a parser: "+t)}function a(t){if("number"!=typeof t)throw new Error("not a number: "+t)}function u(t){if(!(t instanceof RegExp))throw new Error("not a regexp: "+t);for(var e=b(t),n=0;n<e.length;n++){var r=e.charAt(n);if("i"!=r&&"m"!=r&&"u"!=r)throw new Error('unsupported regexp flag "'+r+'": '+t)}}function c(t){if("function"!=typeof t)throw new Error("not a function: "+t)}function h(t){if("string"!=typeof t)throw new Error("not a string: "+t)}function f(t){return 1===t.length?t[0]:"one of "+t.join(", ")}function l(t,e){var n=e.index,r=n.offset;if(r===t.length)return", got the end of the input";var i=r>0?"'...":"'",o=t.length-r>12?"...'":"'";return" at line "+n.line+" column "+n.column+", got "+i+t.slice(r,r+12)+o}function p(t,e){return"expected "+f(e.expected)+l(t,e)}function d(){for(var e=[].slice.call(arguments),r=e.length,o=0;o<r;o+=1)s(e[o]);return t(function(t,o){for(var s,a=new Array(r),u=0;u<r;u+=1){if(s=i(e[u]._(t,o),s),!s.status)return s;a[u]=s.value,o=s.index}return i(n(o,a),s)})}function y(){var t=[].slice.call(arguments);if(0===t.length)throw new Error("seqMap needs at least one argument");var e=t.pop();return c(e),d.apply(null,t).map(function(t){return e.apply(null,t)})}function g(e){return t(e(n,r))}function m(){var e=[].slice.call(arguments),n=e.length;if(0===n)return S("zero alternates");for(var r=0;r<n;r+=1)s(e[r]);return t(function(t,n){for(var r,o=0;o<e.length;o+=1)if(r=i(e[o]._(t,n),r),r.status)return r;return r})}function v(t,e){return w(t,e).or(E([]))}function w(t,e){s(t),s(e);var n=e.then(t).many();return t.chain(function(t){return n.map(function(e){return[t].concat(e)})})}function _(e){h(e);var i="'"+e+"'";return t(function(t,o){var s=o+e.length,a=t.slice(o,s);return a===e?n(s,a):r(o,i)})}function b(t){var e=""+t;return e.slice(e.lastIndexOf("/")+1)}function x(t){return RegExp("^(?:"+t.source+")",b(t))}function k(e,i){u(e),arguments.length>=2?a(i):i=0;var o=x(e),s=""+e;return t(function(t,e){var a=o.exec(t.slice(e));if(a){var u=a[0],c=a[i];if(null!=c)return n(e+u.length,c)}return r(e,s)})}function E(e){return t(function(t,r){return n(r,e)})}function S(e){return t(function(t,n){return r(n,e)})}function N(n){if(e(n))return t(function(t,e){var r=n._(t,e);return r.index=e,r.value="",r});if("string"==typeof n)return N(_(n));if(n instanceof RegExp)return N(k(n));throw new Error("not a string, regexp, or parser: "+n)}function O(e){return c(e),t(function(t,i){var o=t.charAt(i);return i<t.length&&e(o)?n(i+1,o):r(i,"a character matching "+e)})}function T(t){return O(function(e){return t.indexOf(e)>=0})}function A(t){return O(function(e){return t.indexOf(e)<0})}function M(e){return c(e),t(function(t,r){for(var i=r;i<t.length&&e(t.charAt(i));)i++;return n(i,t.slice(r,i))})}function j(e,n){arguments.length<2&&(n=e,e=void 0);var r=t(function(t,e){return r._=n()._,r._(t,e)});return e?r.desc(e):r}function I(t,e){var n=t.slice(0,e).split("\n");return{offset:e,line:n.length,column:n[n.length-1].length+1}}function C(){return S("fantasy-land/empty")}var R=t.prototype;R.parse=function(t){if("string"!=typeof t)throw new Error(".parse must be called with a string as its argument");var e=this.skip(B)._(t,0);return e.status?{status:!0,value:e.value}:{status:!1,index:I(t,e.furthest),expected:e.expected}},R.tryParse=function(t){var e=this.parse(t);if(e.status)return e.value;var n=p(t,e),r=new Error(n);throw r.type="ParsimmonError",r.result=e,r},R.or=function(t){return m(this,t)},R.then=function(t){if("function"==typeof t)throw new Error("chaining features of .then are no longer supported, use .chain instead");return s(t),d(this,t).map(function(t){return t[1]})},R.many=function(){var e=this;return t(function(t,r){for(var o=[],s=void 0;;){if(s=i(e._(t,r),s),!s.status)return i(n(r,o),s);r=s.index,o.push(s.value)}})},R.times=function(e,r){var o=this;return arguments.length<2&&(r=e),a(e),a(r),t(function(t,s){for(var a=[],u=void 0,c=void 0,h=0;h<e;h+=1){if(u=o._(t,s),c=i(u,c),!u.status)return c;s=u.index,a.push(u.value)}for(;h<r&&(u=o._(t,s),c=i(u,c),u.status);h+=1)s=u.index,a.push(u.value);return i(n(s,a),c)})},R.result=function(t){return this.map(function(){return t})},R.atMost=function(t){return this.times(0,t)},R.atLeast=function(t){return y(this.times(t),this.many(),function(t,e){return t.concat(e)})},R.map=function(e){c(e);var r=this;return t(function(t,o){var s=r._(t,o);return s.status?i(n(s.index,e(s.value)),s):s})},R["fantasy-land/map"]=R.map,R.skip=function(t){return d(this,t).map(function(t){return t[0]})},R.mark=function(){return y(U,this,U,function(t,e,n){return{start:t,value:e,end:n}})},R.lookahead=function(t){return this.skip(N(t))},R.desc=function(e){var n=this;return t(function(t,r){var i=n._(t,r);return i.status||(i.expected=[e]),i})},R.fallback=function(t){return this.or(E(t))};var P=t(function(t,e){return e>=t.length?r(e,"any character"):n(e+1,t.charAt(e))}),G=t(function(t,e){return n(t.length,t.slice(e))}),B=t(function(t,e){return e<t.length?r(e,"EOF"):n(e,null)}),U=t(function(t,e){return n(e,I(t,e))});R.concat=R.or,R["fantasy-land/concat"]=R.concat,R.empty=C,R["fantasy-land/empty"]=R.empty,R.of=E,R["fantasy-land/of"]=R.of,R.ap=function(t){return y(t,this,function(t,e){return t(e)})},R["fantasy-land/ap"]=R.ap,R.chain=function(e){var n=this;return t(function(t,r){var o=n._(t,r);return o.status?i(e(o.value)._(t,o.index),o):o})},R["fantasy-land/chain"]=R.chain;var D=k(/[0-9]/).desc("a digit"),L=k(/[0-9]*/).desc("optional digits"),q=k(/[a-z]/i).desc("a letter"),F=k(/[a-z]*/i).desc("optional letters"),z=k(/\s*/).desc("optional whitespace"),J=k(/\s+/).desc("whitespace");return t.all=G,t.alt=m,t.any=P,t.custom=g,t.digit=D,t.digits=L,t.eof=B,t.fail=S,t.formatError=p,t.index=U,t.isParser=e,t.lazy=j,t.letter=q,t.letters=F,t.lookahead=N,t.makeFailure=r,t.makeSuccess=n,t.noneOf=A,t.oneOf=T,t.optWhitespace=z,t.Parser=t,t.regex=k,t.regexp=k,t.sepBy=v,t.sepBy1=w,t.seq=d,t.seqMap=y,t.string=_,t.succeed=E,t.takeWhile=M,t.test=O,t.whitespace=J,t.empty=C,t["fantasy-land/empty"]=C,t.of=E,t["fantasy-land/of"]=E,t})},function(t,e,n){"use strict";function r(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e.default=t,e}function i(t){return t&&t.__esModule?t:{default:t}}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0}),e.Shell=void 0;var s=function(){function t(t,e){var n=[],r=!0,i=!1,o=void 0;try{for(var s,a=t[Symbol.iterator]();!(r=(s=a.next()).done)&&(n.push(s.value),!e||n.length!==e);r=!0);}catch(t){i=!0,o=t}finally{try{!r&&a.return&&a.return()}finally{if(i)throw o}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},u=n(0),c=i(u),h=n(6),f=n(1),l=n(4),p=(n(2),n(5)),d=n(3),y=r(d),g=function t(e){o(this,t),this._root=new f.GraphNode("_root"),this._root.parentId=this._root.id,this._nodes=new Map,this.set(this._root),this._ruleIds=[],this._cwd=this._root,this._nodeStash=[],this._previousLocation=[this._root.id],this._searchResults=[],this._reteNet=new h.ReteNet(e),this._reteNetBackupActions=e,this._reteOutput=[],this._simulation=null,this._parser=p.parser};g.prototype.parse=function(t){var e=this,n=this._parser.parse(t);if(n.status===!1)return console.log("Bad Parse:",n),null;switch(console.log("Parsed: ",n),n=n.value,n.constructor){case y.Cd:this.cdByString(n.id);break;case y.Rm:n.ids.forEach(function(t){e.rm(t)});break;case y.Mk:n.names.forEach(function(t){e.addNode(t)});break;case y.Link:this.link(n.destId,"child","parent",n.sourceId);break;case y.SetTag:this.cwd().tagToggle(n.tagName);break;case y.SetValue:this.cwd().setValue(n.valName,n.value);break;case y.Search:this.search(n.type,n.variable,n.value);break;case y.Refine:this.refine(n.type,n.variable,n.value);break;case y.Apply:throw new Error("Unimplemented: Apply");case y.Import:this.import(n.text);break;case y.Unparameterised:return this.processUnparameterisedCommand(n);default:throw new Error("Unrecognised command parsed")}return null},g.prototype.processUnparameterisedCommand=function(t){switch(t.name){case"export":return this.export();case"stash":this.stash();break;case"unstash":this.unstash();break;case"root":this.cdById(this._root.id);break;case"cwd":return this.printState();case"help":return this.help();case"prior":this.cdById(this.prior());break;case"clear":this._searchResults=[];break;default:throw new Error("Unrecognised Unparameterised Command: "+t.name)}return null},g.prototype.getCtor=l.getCtor,g.prototype.length=function(){return this._nodes.size},g.prototype.numRules=function(){return this._ruleIds.length},g.prototype.has=function(t){return t instanceof f.GraphNode&&(t=t.id),this._nodes.has(t)},g.prototype.get=function(t){if(this.has(Number(t)))return this._nodes.get(Number(t));throw new Error("Node "+t+" does not exist")},g.prototype.set=function(t){if(!(t instanceof f.GraphNode))throw new Error("Cannot add a non-GraphNode");if(this.has(t.id))throw new Error("Cannot replace already existing nodes");this._nodes.set(t.id,t)},g.prototype.rm=function(t){if(t instanceof f.GraphNode&&(t=t.id),!this.has(t))throw new Error("Can't remove a node that doesn't exist");var e=!0,n=!1,r=void 0;try{for(var i,o=this.get(t)._edges.keys()[Symbol.iterator]();!(e=(i=o.next()).done);e=!0){var s=i.value;this.get(s).removeEdge(t)}}catch(t){n=!0,r=t}finally{try{!e&&o.return&&o.return()}finally{if(n)throw r}}this._nodes.delete(t)},g.prototype.root=function(){return this._root},g.prototype.cwd=function(){return this._cwd},g.prototype.prior=function(){return c.default.last(this._previousLocation)},g.prototype.searchResults=function(){return Array.from(this._searchResults)},g.prototype.reteOutput=function(){return Array.from(this._reteOutput)},g.prototype.link=function(t,e,n,r){var i=r?this.get(r):this.cwd(),o=this.get(t);i.setEdge(o.id,{id:i.id,relation:n},{},{id:o.id,relation:e}),o.setEdge(i.id,{id:i.id,relation:n},{},{id:o.id,relation:e})},g.prototype.addNode=function(t,e,n,r,i,o){var s=o?this.get(o):this.cwd();null!==t&&void 0!==t&&""!==t||(t=n||"anon"),n=n||"parent",e=e||"child",r=r||"graphnode";var a=(0,l.getCtor)(r),u=new a(t,s.id);return this.set(u),this.link(u.id,e,n,s.id),u.id},g.prototype.deleteNode=function(t){this.rm(t)},g.prototype.cdByString=function(t){if(!Number.isNaN(Number(t)))return void this.cdById(Number(t));if(null===t.match(/\.\./))throw new Error("Unimplemented: "+t);this.cdById(this.cwd().parentId)},g.prototype.cdById=function(t){if("number"!=typeof t)throw new Error("Cd'ing needs an id, instead got "+(void 0===t?"undefined":a(t)));if(!this.has(t))throw new Error("Can't cd to a non-existent node");this._previousLocation.push(this.cwd().id),this._cwd=this.get(t)},g.prototype.stash=function(){this._nodeStash.push(this.cwd().id)},g.prototype.unstash=function(){return this._nodeStash.pop()},g.prototype.getStash=function(){return c.default.clone(this._nodeStash)},g.prototype.export=function(){var t=[],e=!0,n=!1,r=void 0;try{for(var i,o=this._nodes.values()[Symbol.iterator]();!(e=(i=o.next()).done);e=!0){var s=i.value;t.push(s.toJSONCompatibleObj())}}catch(t){n=!0,r=t}finally{try{!e&&o.return&&o.return()}finally{if(n)throw r}}return{description:"json",text:JSON.stringify({nodes:t,root:this._root.id})}},g.prototype.import=function(t){var e=JSON.parse(t);this._nodes=new Map;var n=!0,r=!1,i=void 0;try{for(var o,s=e.nodes[Symbol.iterator]();!(n=(o=s.next()).done);n=!0){var a=o.value,u=f.GraphNode.fromJSON(a);this.set(u)}}catch(t){r=!0,i=t}finally{try{!n&&s.return&&s.return()}finally{if(r)throw i}}this._root=this._nodes.get(e.root),this._cwd=this._root},g.prototype.search=function(t,e,n){var r=this,i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],o=[];switch(o=i?this._searchResults.map(function(t){return r.get(t)}):Array.from(this._nodes.values()),t){case"name":if(null!==n||!(e instanceof RegExp))throw new Error("Incorrect Name Search");var a=o.filter(function(t){return e.test(t.name())});this._searchResults=a.map(function(t){return t.id});break;case"tag":if(null!==n||!(e instanceof RegExp))throw new Error("Incorrect Tag Search");console.log("Searching for a tag:");var u=o.map(function(t){return[t.id,t.tags()]}),h=u.filter(function(t){var n=s(t,2),r=(n[0],n[1]);return c.default.some(r,function(t){return e.test(t)})}),f=h.map(function(t){var e=s(t,2),n=e[0];e[1];return n});this._searchResults=f;break;case"value":if(!(null!==n&&e instanceof RegExp&&n instanceof RegExp))throw new Error("Incorrect Value Search");var l=o.filter(function(t){return c.default.some(t.values(),function(t){var r=s(t,2),i=r[0],o=r[1];return e.test(i)&&n.test(o)})});this._searchResults=l.map(function(t){return t.id});break;case"edge":if(null===n||!/dest|source/.test(e))throw new Error("Incorrect Edge Search");var p=o.filter(function(t){return t.hasEdgeWith(n)&&t.getEdgeTo(n).idMatches(n,e)});this._searchResults=p.map(function(t){return t.id});break;default:throw new Error("Incorrect Search Specified")}},g.prototype.refine=function(t,e,n){return this.search(t,e,n,!0)},g.prototype.dfs=function(){throw new Error("Unimplemented: DFS")},g.prototype.bfs=function(){throw new Error("Unimplemented: BFS")},g.prototype.help=function(){throw new Error("Unimplemented: Help")},g.prototype.getPath=function(){for(var t=[],e=this.cwd();e.id!==this._root.id&&e.parentId!==e.id;)t.unshift([e.name(),e.id]),e=this.get(e.parentId);return t.unshift([this._root.name(),this._root.id]),t},g.prototype.printState=function(){var t=this.cwd();return{description:"stateDescription",inputs:t.getParents(),node:t,outputs:t.getChildren(),searchResults:c.default.clone(this._searchResults),currentPath:this.getPath(),stash:this.getStash()}},e.Shell=g}])});